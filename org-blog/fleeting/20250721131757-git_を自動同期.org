:PROPERTIES:
:ID:       948E9308-00DE-4D92-A23B-ABE075B61BE9
:END:
#+TITLE: git ã‚’è‡ªå‹•åŒæœŸ
#+begin_src shell
  #!/bin/bash
  # =============================================
  # Git Auto Sync - expectçµ±åˆç‰ˆ
  # =============================================

  # è¨­å®š
  REPOS=(
      "$HOME/.emacs.d"
      "$HOME/blog"
      # è¿½åŠ ã—ãŸã„ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‘ã‚¹ã‚’ã“ã“ã«è¨˜è¼‰
  )

  # =============================================
  # expectè‡ªå‹•åŒ–é–¢æ•°
  # =============================================

  setup_git_and_ssh() {
      echo "ğŸ”§ Setting up Git & SSH..."

      # expectã®å­˜åœ¨ç¢ºèª
      if ! command -v expect >/dev/null 2>&1; then
          echo "âš ï¸  expect not found. Install: brew install expect (macOS) or sudo apt install expect (Linux)"
          echo "ğŸ”‘ Manual SSH key setup..."
          eval "$(ssh-agent -s)" >/dev/null
          ssh-add ~/.ssh/id_ed25519 2>/dev/null || echo "Enter SSH passphrase manually"
          return 1
      fi

      # expectè‡ªå‹•åŒ–å®Ÿè¡Œ
      expect << 'EOF' >/dev/null 2>&1
  set timeout 30

  # SSH Agenté–‹å§‹
  spawn bash -c {eval "$(ssh-agent -s)"}
  expect eof

  # SSH keyè¿½åŠ ï¼ˆãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºè‡ªå‹•å…¥åŠ›ï¼‰
  spawn ssh-add ~/.ssh/id_ed25519
  expect {
      "Enter passphrase" {
          send "Rikuto13\r"
          expect eof
      }
      "Identity added" { }
      eof
  }

  # SSHæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è‡ªå‹•å…¥åŠ›ï¼‰
  spawn ssh -T rikuto
  expect {
      "password:" {
          send "Rikuto13\r"
          expect eof
      }
      "yes/no" {
          send "yes\r"
          expect {
              "password:" {
                  send "Rikuto13\r"
                  expect eof
              }
              eof
          }
      }
      "successfully authenticated" { }
      timeout { }
      eof
  }
  EOF

      echo "âœ… SSH setup completed"
  }

  setup_local_git_config() {
      local repo="$1"

      # expectã§ãƒ­ãƒ¼ã‚«ãƒ«Gitè¨­å®š
      expect << EOF >/dev/null 2>&1
  set timeout 10

  spawn git config --local user.name "rikuto1367@gmail.com"
  expect eof

  spawn git config --local user.email "Rikuto13ten"
  expect eof
  EOF

      echo "   ğŸ“ Git config set"
  }

  # =============================================
  # åˆæœŸè¨­å®š
  # =============================================

  # ã‚°ãƒ­ãƒ¼ãƒãƒ«Gitè¨­å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
  if [ -z "$(git config --global user.name)" ]; then
      git config --global user.name "rikuto1367@gmail.com"
      git config --global user.email "Rikuto13ten"
  fi

  # SSHè‡ªå‹•è¨­å®š
  setup_git_and_ssh

  # =============================================
  # åŒæœŸå‡¦ç†
  # =============================================

  echo "ğŸš€ Starting sync at $(date '+%H:%M:%S')"

  for repo in "${REPOS[@]}"; do
      # ãƒªãƒã‚¸ãƒˆãƒªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
      if [ ! -d "$repo" ]; then
          echo "âš ï¸  $repo (not found)"
          continue
      fi

      echo "ğŸ”„ $repo"
      cd "$repo" || continue

      # Gitãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯
      if ! git rev-parse --git-dir >/dev/null 2>&1; then
          echo "   âš ï¸  Not a git repository"
          continue
      fi

      # ãƒ­ãƒ¼ã‚«ãƒ«Gitè¨­å®š
      setup_local_git_config "$repo"

      # HTTPSã‹ã‚‰SSHã«å¤‰æ›´ï¼ˆå¿…è¦æ™‚ï¼‰
      remote_url=$(git remote get-url origin 2>/dev/null)
      if [[ "$remote_url" == https://github.com/* ]]; then
          ssh_url=$(echo "$remote_url" | sed 's#https://github.com/#git@github.com:#')
          git remote set-url origin "$ssh_url"
          echo "   ğŸ”— Converted to SSH"
      fi

      # ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ›´ã‚’stash
      stashed=0
      if [ -n "$(git status --porcelain)" ]; then
          git stash push -m "auto-$(date '+%H%M%S')" >/dev/null 2>&1
          stashed=1
          echo "   ğŸ“¦ Stashed changes"
      fi

      # Pullï¼ˆmainå„ªå…ˆã€æ¬¡ã«masterï¼‰
      echo "   ğŸ”„ Fetching..."
      git fetch origin >/dev/null 2>&1

      if git pull --rebase origin main >/dev/null 2>&1; then
          echo "   â¬‡ï¸  Pulled (main)"
          current_branch="main"
      elif git pull --rebase origin master >/dev/null 2>&1; then
          echo "   â¬‡ï¸  Pulled (master)"
          current_branch="master"
      else
          echo "   âŒ Pull failed"
          [ "$stashed" = "1" ] && git stash pop >/dev/null 2>&1
          continue
      fi

      # Stashå¾©å…ƒ
      if [ "$stashed" = "1" ]; then
          git stash pop >/dev/null 2>&1
          echo "   ğŸ“¦ Restored changes"
      fi

      # Pushï¼ˆå¤‰æ›´ãŒã‚ã‚Œã°ï¼‰
      if [ -n "$(git status --porcelain)" ]; then
          echo "   ğŸ“ Committing..."
          git add .
          git commit -m "Auto-sync $(date '+%Y-%m-%d %H:%M:%S')" >/dev/null 2>&1

          if git push origin "$current_branch" >/dev/null 2>&1; then
              echo "   â¬†ï¸  Pushed"
          else
              echo "   âŒ Push failed"
          fi
      fi

      # è¨­å®šç¢ºèªï¼ˆåˆå›ã®ã¿è¡¨ç¤ºï¼‰
      if [[ "$repo" == "${REPOS[0]}" ]]; then
          echo "   â„¹ï¸  Git config: $(git config user.name) <$(git config user.email)>"
      fi

      echo "   âœ… Done"
  done

  echo "ğŸ‰ Sync completed at $(date '+%H:%M:%S')"
#+end_src
