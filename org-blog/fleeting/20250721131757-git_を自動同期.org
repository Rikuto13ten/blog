:PROPERTIES:
:ID:       948E9308-00DE-4D92-A23B-ABE075B61BE9
:END:
#+TITLE: git ã‚’è‡ªå‹•åŒæœŸ
#+begin_src shell
#!/bin/bash
# =============================================
# Git Auto Sync - ç¶™ç¶šå®Ÿè¡Œç‰ˆ
# =============================================

# è¨­å®š
REPOS=(
    "$HOME/.emacs.d"
    "$HOME/blog"
)

SYNC_INTERVAL=300  # 5åˆ† = 300ç§’

# =============================================
# é–¢æ•°
# =============================================

log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

setup_ssh() {
    if [ -z "$SSH_AUTH_SOCK" ]; then
        eval "$(ssh-agent -s)" >/dev/null
    fi
    
    if ! ssh-add -l 2>/dev/null | grep -q "id_ed25519"; then
        log "ğŸ”‘ Adding SSH key..."
        if command -v expect >/dev/null 2>&1; then
            expect -c 'spawn ssh-add ~/.ssh/id_ed25519; expect "Enter passphrase" { send "Rikuto13\r" }; expect eof' >/dev/null 2>&1
        else
            ssh-add ~/.ssh/id_ed25519 2>/dev/null
        fi
    fi
}

sync_repo() {
    local repo="$1"
    local repo_name=$(basename "$repo")
    
    if [ ! -d "$repo" ]; then
        log "âš ï¸  $repo_name (not found)"
        return 1
    fi
    
    cd "$repo" || return 1
    
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        log "âš ï¸  $repo_name (not git repo)"
        return 1
    fi
    
    # Gitè¨­å®š
    git config --local user.name "rikuto1367@gmail.com" 2>/dev/null
    git config --local user.email "Rikuto13ten" 2>/dev/null
    
    # HTTPSâ†’SSHå¤‰æ›
    remote_url=$(git remote get-url origin 2>/dev/null)
    if [[ "$remote_url" == https://github.com/* ]]; then
        ssh_url=$(echo "$remote_url" | sed 's#https://github.com/#git@github.com:#')
        git remote set-url origin "$ssh_url"
        log "ğŸ”— $repo_name: Converted to SSH"
    fi
    
    # Stash
    stashed=0
    if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
        git stash push -m "auto-$(date '+%H%M%S')" >/dev/null 2>&1
        stashed=1
    fi
    
    # Pull
    git fetch origin >/dev/null 2>&1
    current_branch=""
    
    if git pull --rebase origin main >/dev/null 2>&1; then
        current_branch="main"
    elif git pull --rebase origin master >/dev/null 2>&1; then
        current_branch="master"
    else
        log "âŒ $repo_name: Pull failed"
        [ "$stashed" = "1" ] && git stash pop >/dev/null 2>&1
        return 1
    fi
    
    # Restore stash
    if [ "$stashed" = "1" ]; then
        git stash pop >/dev/null 2>&1
    fi
    
    # Push if changes
    if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
        git add . >/dev/null 2>&1
        git commit -m "Auto-sync $(date '+%Y-%m-%d %H:%M:%S')" >/dev/null 2>&1
        
        if git push origin "$current_branch" >/dev/null 2>&1; then
            log "ğŸ“¤ $repo_name: Changes pushed"
        else
            log "âŒ $repo_name: Push failed"
            return 1
        fi
    else
        log "âœ… $repo_name: Up to date"
    fi
    
    return 0
}

sync_all() {
    log "ğŸ”„ Starting sync..."
    local success=0
    local total=${#REPOS[@]}
    
    for repo in "${REPOS[@]}"; do
        if sync_repo "$repo"; then
            ((success++))
        fi
    done
    
    log "ğŸ“Š Sync completed: $success/$total repositories"
}

# =============================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# =============================================

main() {
    log "ğŸš€ Git Auto Sync started (interval: ${SYNC_INTERVAL}s)"
    log "ğŸ“ Repositories: ${#REPOS[@]}"
    
    # åˆæœŸSSHè¨­å®š
    setup_ssh
    
    # åˆå›å®Ÿè¡Œ
    sync_all
    
    # ç¶™ç¶šå®Ÿè¡Œ
    while true; do
        log "â° Next sync in ${SYNC_INTERVAL}s... (Press Ctrl+C to stop)"
        sleep "$SYNC_INTERVAL"
        
        # SSHå†ç¢ºèª
        if ! ssh-add -l >/dev/null 2>&1; then
            log "ğŸ”‘ Re-adding SSH key..."
            setup_ssh
        fi
        
        sync_all
    done
}

# çµ‚äº†å‡¦ç†
cleanup() {
    log "ğŸ›‘ Stopping Git Auto Sync..."
    exit 0
}

trap cleanup SIGINT SIGTERM

# å¼•æ•°å‡¦ç†
case "${1:-}" in
    -h|--help)
        echo "Usage: $0 [--once] [--interval SECONDS]"
        echo "  --once              Run sync once and exit"
        echo "  --interval SECONDS  Set sync interval (default: 300)"
        echo "  --help              Show this help"
        exit 0
        ;;
    --once)
        log "ğŸš€ Running single sync..."
        setup_ssh
        sync_all
        log "âœ… Single sync completed"
        exit 0
        ;;
    --interval)
        if [[ "$2" =~ ^[0-9]+$ ]] && [ "$2" -gt 0 ]; then
            SYNC_INTERVAL="$2"
            log "â±ï¸  Interval set to ${SYNC_INTERVAL}s"
        else
            echo "Error: Invalid interval. Must be positive integer."
            exit 1
        fi
        ;;
esac

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main
#+end_src
